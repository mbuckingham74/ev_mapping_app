# EA Route Planner

## Business Case

### The Problem

Cross-country EV travel on the Electrify America network requires careful route planning due to variable distances between charging stations. Current tools (EA app, Google Maps, PlugShare) show station locations but don't optimize for:

- Actual driving distances between EA-only stations
- Whether skipping a station is safe given real-world range
- Station quality factors that significantly impact charging time and experience

### The Real-World Scenario

A driver with a Kia EV6 (215-mile reliable range) traveling from The Villages, FL to Seattle, WA faces decisions at every stop:

- "Do I need to stop in Atlanta, or can I make it to Macon?"
- "There are three stations in Lexington - which one won't waste my time?"
- "If I draft a semi for 40 miles, can I skip this stop entirely?"

Current tools don't answer these questions well.

### Why This Matters

- **Charging speed variance is massive**: 350kW stations deliver ~248kW actual, while 150kW stations often deliver ~60kW. That's 4x difference in charging time.
- **Station quality varies**: A 6-charger station at Walmart beats a 3-charger station at a car dealer every time.
- **Range anxiety is real**: Knowing exact distances and having a plan reduces stress and enables smarter decisions.

### Target User

EV drivers who:
- Travel long distances on the EA network
- Have significant EA credits or prefer EA for other reasons
- Want to optimize for time, not just "make it to the next station"

---

## Data Sources

### Primary: NREL AFDC API

**Endpoint:** `GET /api/alt-fuel-stations/v1.json`

**Key parameters:**
- `fuel_type=ELEC`
- `ev_network=Electrify America`
- `ev_charging_level=dc_fast`
- `status=E` (available stations)
- `access=public`
- `country=US`

**Available fields:**
| Field | Description | Use |
|-------|-------------|-----|
| `id` | Unique station ID | Primary key |
| `station_name` | Name (often includes business) | Display, business identification |
| `street_address`, `city`, `state`, `zip` | Location | Display, geocoding backup |
| `latitude`, `longitude` | Coordinates | Mapping, distance calculation |
| `ev_dc_fast_num` | Number of DC fast ports | Station ranking |
| `ev_connector_types` | CCS, CHAdeMO, etc. | Compatibility filtering |
| `facility_type` | WALMART, CAR_DEALER, etc. | Station ranking |
| `status_code` | E (available), P (planned), T (temp unavailable) | Filtering |
| `ev_pricing` | Text description of pricing | Display only (not structured) |
| `access_days_time` | Hours of operation | Display |

**Limitations:**
- No real-time charger availability (EA doesn't expose this publicly)
- No per-charger speed data (station-level only)
- `ev_pricing` is unstructured text, not usable for calculations

**Update frequency:** Daily via EA's API feed to NREL

### Secondary: OpenChargeMap API (for charger speed data)

**Endpoint:** `GET https://api.openchargemap.io/v3/poi/`

**Key parameters:**
- `operatorid` - Filter by network (EA has an operator ID)
- `countrycode=US`
- `maxresults`
- `key` - Free API key required

**Key fields:**
| Field | Description |
|-------|-------------|
| `Connections[].PowerKW` | Power output in kilowatts per charger |
| `Connections[].ConnectionTypeID` | Connector type (CCS, CHAdeMO, etc.) |
| `Connections[].Quantity` | Number of this connector type |
| `AddressInfo.Latitude/Longitude` | For matching to NREL data |

**Limitations:**
- Crowdsourced data - some stations may have incomplete/inaccurate kW
- Requires matching to NREL data by coordinates (no shared station ID)
- Update frequency varies by contributor activity

### Tertiary: Routing/Elevation APIs

**For driving distances (need one of these):**

| Service | Pros | Cons |
|---------|------|------|
| OSRM (Open Source Routing Machine) | Free, self-hostable | Need to host or use limited public demo |
| OpenRouteService | Free tier (2,000 req/day) | Rate limited |
| Google Directions API | Accurate, reliable | Paid ($5/1000 requests) |
| Mapbox Directions | Free tier available | Rate limited |

**For elevation data:**

| Service | Pros | Cons |
|---------|------|------|
| OpenTopoData | Free, open source | Self-host or use public API |
| Google Elevation API | Accurate | Paid |
| USGS Elevation Point Query | Free, authoritative | Slower, US only |

**Recommendation:** OpenRouteService for routing + elevation (provides both in one call)

### Not Available

- **Real-time charger status**: EA doesn't expose publicly. Only available via EA app or partner integrations (Ford, Porsche, Lucid).
- **Actual charger speeds per unit**: NREL doesn't distinguish 150kW vs 350kW chargers at the same station.
- **Structured pricing data**: Would require scraping EA's app/website.

---

## Requirements

### Must Have (v1)

1. **Station Data**
   - [ ] All EA DC fast charging stations in the US
   - [ ] Station name and business/facility type
   - [ ] Address and coordinates
   - [ ] Number of DC fast chargers
   - [ ] Connector types

2. **Route Graph**
   - [ ] Pre-computed driving distances between stations within 220 miles of each other
   - [ ] Net elevation change for each station-to-station segment
   - [ ] Edges limited to "forward progress" directions (optimization, not all pairs)

3. **Station Ranking**
   - [ ] Rank by charger speed (350kW >> 150kW) - *NOTE: need to determine data source*
   - [ ] Rank by charger count (more = better)
   - [ ] Rank by facility type (Walmart/Target > Travel Center > Gas Station > Car Dealer)

4. **Planning Mode**
   - [ ] Set origin and destination (any US address)
   - [ ] Display route with EA stations and distances between them
   - [ ] Show station details: name, business, charger count, facility type
   - [ ] Flag "tight" segments (180-200 miles) and "risky" segments (200+ miles)
   - [ ] Show alternative station choices with tradeoffs

5. **On-Road Mode**
   - [ ] Input current location and battery percentage
   - [ ] Show next 3-5 reachable stations with distances
   - [ ] Calculate estimated arrival battery percentage (based on distance, user's efficiency)
   - [ ] Highlight recommended station based on ranking

### Should Have (v1.1)

6. **Time Optimization**
   - [ ] Calculate total time (drive time + estimated charge time) for station choices
   - [ ] Suggest "drive further for faster charger" when time-optimal

7. **User Preferences**
   - [ ] Set vehicle range (different EVs)
   - [ ] Set efficiency (mi/kWh) - adjustable for conditions
   - [ ] Set minimum arrival battery percentage (comfort buffer)
   - [ ] Facility type preferences (exclude car dealers, etc.)

8. **Segment Warnings**
   - [ ] Flag routes with no viable EA path (gaps > user's range)
   - [ ] Suggest alternative networks if EA-only isn't possible (out of scope for v1?)

### Nice to Have (v2+)

9. **Elevation-Adjusted Range**
   - [ ] Estimate range impact based on elevation change
   - [ ] "This segment is 150mi but 2,000ft climb - treat as 180mi"

10. **Offline/PWA Support**
    - [ ] Cache station data and route graph for offline planning
    - [ ] GPS-based "where am I" in on-road mode

11. **Pricing Display**
    - [ ] Show state-level pricing model (kWh vs per-minute)
    - [ ] Manual price database (community maintained?)

---

## Architecture Direction

### Target Platforms
- **Web app** (desktop/tablet) - Primary for trip planning at home
- **Mobile app** (phone) - Primary for on-road decisions
- **Single codebase** via Progressive Web App (PWA)

### Why PWA

| Requirement | PWA Support |
|-------------|-------------|
| GPS/Geolocation | ✅ Yes (foreground) |
| Offline access | ✅ Yes (service worker + cached data) |
| Install to home screen | ✅ Yes (iOS + Android) |
| No app store approval | ✅ Yes |
| Single codebase | ✅ Yes |
| Background GPS | ❌ No (not needed) |
| CarPlay integration | ❌ No (not needed) |

### Mobile Use Case

User is driving, pulls into rest stop or passenger checks phone:
1. Open app (already installed to home screen)
2. GPS auto-detects current location
3. See next 3-5 reachable EA stations with:
   - Distance from current location
   - Estimated arrival battery % (based on input current %)
   - Station rank (speed, count, facility)
4. Tap station for details
5. Pick station, continue driving

No background tracking needed. App only active when user is making a decision.

### Data Architecture

```
┌─────────────────────────────────────────────────────────┐
│                      PWA Client                         │
│  ┌───────────────┐  ┌───────────────┐  ┌─────────────┐ │
│  │ Planning Mode │  │ On-Road Mode  │  │ Offline     │ │
│  │ (route view)  │  │ (GPS + next)  │  │ Cache       │ │
│  └───────────────┘  └───────────────┘  └─────────────┘ │
└─────────────────────────────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────┐
│                    Static Data (JSON)                   │
│  ┌───────────────┐  ┌───────────────────────────────┐  │
│  │ stations.json │  │ edges.json                    │  │
│  │ - id, name    │  │ - from_station, to_station   │  │
│  │ - lat, lng    │  │ - distance_miles             │  │
│  │ - chargers    │  │ - elevation_change_ft        │  │
│  │ - facility    │  │                               │  │
│  │ - speed_kw    │  │                               │  │
│  └───────────────┘  └───────────────────────────────┘  │
└─────────────────────────────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────┐
│              Build Pipeline (offline/scheduled)         │
│  1. Fetch NREL API → stations                          │
│  2. Enrich with charger speeds (source TBD)            │
│  3. Compute edges via routing API                       │
│  4. Fetch elevation data                                │
│  5. Output static JSON files                            │
└─────────────────────────────────────────────────────────┘
```

### Hosting

Static hosting (Vercel, Netlify, GitHub Pages, Cloudflare Pages) - no backend server needed. All logic runs client-side.

Data refresh: Rebuild and redeploy JSON files weekly or when EA network changes significantly.

---

## Open Questions

1. **Charger speed data**: NREL doesn't provide per-charger kW ratings. 
   
   **SOLUTION**: Cross-reference with OpenChargeMap API, which has `PowerKW` field per connection.
   - OpenChargeMap is free, open data
   - Data is crowdsourced so may have gaps
   - For stations missing kW data, use conservative default (150kW) or flag as "speed unknown"
   - Build pipeline: NREL (primary) → match to OpenChargeMap by lat/long → extract kW data

2. **"Forward progress" edges**: How do we define which station-to-station connections to pre-compute?
   
   **DECISION**: Pre-compute all pairs within 220 miles.
   - Results in ~12,000-15,000 edges total
   - Simple and complete - no bearing-based filtering needed
   - Storage is trivial (~2-5MB JSON)

3. **Elevation impact formula**: How much does elevation affect range? 
   
   **DECISION**: 1% range penalty per 100ft of elevation gain.
   - Validated against 40,000 miles of real-world EV driving experience
   - Matches crowdsourced data from EV community
   - Example: 150mi segment with 1,500ft climb = ~165mi effective range consumption

4. **Hosting model**: 
   
   **DECISION**: Static build + Nginx Proxy Manager on VPS (tachyonfuture.com)
   - Static JSON data files, no backend for v1
   - Postgres available for v1.1+ if needed (user accounts, saved routes)

5. **Facility type ranking** (for station preference scoring):
   
   **DECISION**: Ranked best to worst:
   1. Walmart / Target / Costco
   2. Travel Center / Truck Stop / Rest Stop  
   3. Grocery Store
   4. Shopping Center / Mall
   5. Gas Station / Convenience Store
   6. Hotel
   7. Car Dealer

---

## Credentials & Access

### API Keys

| Service | Key | Sign Up URL |
|---------|-----|-------------|
| NREL AFDC | `[gCpabQpqabhWaJYmhnuwyBvV4aPsG574WFWCK6Xa]` | https://developer.nrel.gov/signup/ |
| OpenChargeMap | `[84313427-05c5-4a56-9ed1-7c6c7f07ab68]` | https://openchargemap.org/site/develop |
| OpenRouteService | `[eyJvcmciOiI1YjNjZTM1OTc4NTExMTAwMDFjZjYyNDgiLCJpZCI6IjkzOWNjMGYyNTkwYTRkNmM4NDYwMmIyZjYyNzI4NDM0IiwiaCI6Im11cm11cjY0In0=]` | https://openrouteservice.org/dev/#/signup |

### Server Access

```
Host: tachyonfuture.com
User: michael
Auth: SSH private key (passkey-protected on Mac)
Command: ssh michael@tachyonfuture.com
```

### Nginx Proxy Manager

```
URL: [https://npm.tachyonfuture.com]
User: [michael.buckingham74@gmail.com]
Password: [Lt2gmscf64iFUnrWRX4yL_JBd]
```

### Database (for v1.1+)

```
Type: Postgres
Host: [ADD HOST - likely localhost or container name]
Port: 5432
Database: [ADD DB NAME]
User: [ADD USERNAME]
Password: [ADD PASSWORD]
```

### Deployment Path

```
Domain: https://ev.tachyonfuture.com
Build output: /var/www/ev-planner/dist (or container volume)
NPM proxy target: [ADD - e.g., http://localhost:3000 or container:port]
```

---

## Notes

*Space for ongoing discussion and decisions*

- 
