# EA Route Planner - Technical Documentation

## Overview

EA Route Planner is a web application for finding and planning routes between Electrify America (EA) charging stations. It displays EA stations on an interactive map and provides station details including charger count, power output, and location information.

**Live URL:** https://ev.tachyonfuture.com
**GitHub:** https://github.com/mbuckingham74/ev_mapping_app

---

## Architecture

```
┌─────────────────────────────────────────────────────────────────┐
│                        Nginx Proxy Manager                       │
│                    (ev.tachyonfuture.com:443)                   │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                         npm_network                              │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐ │
│  │    Frontend     │  │    Backend      │  │    Postgres     │ │
│  │  (nginx:alpine) │  │  (node:alpine)  │  │  (postgres:16)  │ │
│  │     :80         │──│     :3001       │──│     :5432       │ │
│  │                 │  │                 │  │                 │ │
│  │ ea-planner-     │  │ ea-planner-     │  │ ea-planner-     │ │
│  │ frontend        │  │ backend         │  │ postgres        │ │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
```

### Request Flow

1. User visits https://ev.tachyonfuture.com
2. Nginx Proxy Manager terminates SSL and forwards to `ea-planner-frontend:80`
3. Frontend (nginx) serves static React app
4. React app makes API calls to `/api/*`
5. Frontend nginx proxies `/api/*` requests to `ea-planner-backend:3001`
6. Backend queries Postgres database and returns JSON

---

## Technology Stack

### Frontend (`/client`)
- **React 19** - UI framework
- **TypeScript** - Type safety
- **Vite** - Build tool and dev server
- **Tailwind CSS v4** - Styling
- **React-Leaflet** - Map component (OpenStreetMap tiles)
- **nginx:alpine** - Production web server

### Backend (`/server`)
- **Node.js 22** - Runtime
- **Express.js 5** - Web framework
- **TypeScript** - Type safety
- **pg (node-postgres)** - PostgreSQL client
- **CORS** - Cross-origin resource sharing

### Database
- **PostgreSQL 16** (Alpine)
- Single `stations` table

### Infrastructure
- **Docker** & **Docker Compose** - Containerization
- **Nginx Proxy Manager** - Reverse proxy & SSL
- **Let's Encrypt** - SSL certificates

---

## Project Structure

```
ev-app/
├── client/                    # React frontend
│   ├── src/
│   │   ├── App.tsx           # Main app with map
│   │   ├── index.css         # Tailwind imports
│   │   ├── main.tsx          # React entry point
│   │   ├── services/
│   │   │   └── api.ts        # API client functions
│   │   └── types/
│   │       └── station.ts    # TypeScript interfaces
│   ├── Dockerfile            # Multi-stage build → nginx
│   ├── nginx.conf            # Nginx config with /api proxy
│   ├── package.json
│   ├── vite.config.ts        # Vite + Tailwind config
│   └── tsconfig.json
│
├── server/                    # Express backend
│   ├── src/
│   │   ├── index.ts          # Express server entry
│   │   ├── db.ts             # Postgres connection & schema
│   │   └── routes/
│   │       └── stations.ts   # /api/stations routes
│   ├── scripts/
│   │   └── fetch-stations.ts # Data import script (NREL)
│   ├── Dockerfile            # Multi-stage build
│   ├── package.json
│   └── tsconfig.json
│
├── docker-compose.yml         # All 3 services
├── package.json               # Monorepo root (workspaces)
├── .env                       # Environment variables (gitignored)
├── .env.example               # Template for .env
├── .gitignore
├── .EV_PLANNING.md           # Original planning document
└── .ev_mapping_app.md        # This file
```

---

## Database Schema

### `stations` Table

```sql
CREATE TABLE stations (
  id INTEGER PRIMARY KEY,           -- Station ID (from data source)
  station_name TEXT NOT NULL,       -- Display name
  street_address TEXT,              -- Street address
  city TEXT,                        -- City
  state TEXT,                       -- State abbreviation (e.g., "FL")
  zip TEXT,                         -- ZIP code
  latitude DOUBLE PRECISION NOT NULL,
  longitude DOUBLE PRECISION NOT NULL,
  ev_dc_fast_num INTEGER DEFAULT 0, -- Number of DC fast chargers
  ev_connector_types TEXT[],        -- Array of connector types
  facility_type TEXT,               -- e.g., "WALMART", "TARGET", "OTHER"
  status_code TEXT,                 -- "E" = available, "T" = temp unavailable
  ev_pricing TEXT,                  -- Pricing info (text)
  access_days_time TEXT,            -- Hours of operation
  max_power_kw INTEGER              -- Maximum charger power in kW
);

CREATE INDEX idx_stations_state ON stations(state);
CREATE INDEX idx_stations_coords ON stations(latitude, longitude);
```

---

## API Endpoints

Base URL: `https://ev.tachyonfuture.com/api`

### GET /stations
Returns all stations, optionally filtered by state.

```bash
# All stations
curl https://ev.tachyonfuture.com/api/stations

# Filter by state
curl https://ev.tachyonfuture.com/api/stations?state=FL
```

**Response:** Array of station objects

### GET /stations/:id
Returns a single station by ID.

```bash
curl https://ev.tachyonfuture.com/api/stations/123456
```

### GET /stations/near/:lat/:lng
Returns stations near a location, sorted by distance.

```bash
# Stations within 100 miles of Orlando
curl "https://ev.tachyonfuture.com/api/stations/near/28.5384/-81.3789?radius=100&limit=20"
```

**Query params:**
- `radius` - Search radius in miles (default: 100)
- `limit` - Max results (default: 20)

### GET /stations/stats/count
Returns total station count.

```bash
curl https://ev.tachyonfuture.com/api/stations/stats/count
# {"total":1129}
```

### GET /health
Health check endpoint.

```bash
curl https://ev.tachyonfuture.com/api/health
# {"status":"ok","timestamp":"2025-12-17T00:45:00.000Z"}
```

---

## Docker Configuration

### docker-compose.yml

Three services on the `npm_network` (external network managed by Nginx Proxy Manager):

| Service | Container Name | Image | Port | Purpose |
|---------|---------------|-------|------|---------|
| frontend | ea-planner-frontend | nginx:alpine | 80 | Serves React app, proxies /api |
| backend | ea-planner-backend | node:22-alpine | 3001 | Express API server |
| postgres | ea-planner-postgres | postgres:16-alpine | 5432 | Database |

### Environment Variables

The backend reads from environment variables set in `docker-compose.yml`:

```yaml
environment:
  - NODE_ENV=production
  - PORT=3001
  - DB_HOST=postgres           # Container name
  - DB_PORT=5432
  - DB_NAME=ea_planner
  - DB_USER=ea_planner
  - DB_PASSWORD=${DB_PASSWORD}  # From .env file
  - CORS_ORIGIN=https://ev.tachyonfuture.com
```

### Frontend Nginx Config

The frontend nginx proxies API requests to the backend:

```nginx
location /api/ {
    proxy_pass http://backend:3001/api/;
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
}
```

---

## Data Sources

### Primary: OpenChargeMap API
- **URL:** https://api.openchargemap.io/v3/poi/
- **Operator ID:** 3318 (Electrify America)
- **Current data:** 1,129 stations

### Alternative: NREL AFDC API (currently unreachable)
- **URL:** https://api.nrel.gov/alt-fuel-stations/v1.json
- **Note:** Connection times out from both local and server networks

### Data Import Process

Since NREL API is unreachable, data is fetched from OpenChargeMap:

```bash
# On server, fetch data
curl -s "https://api.openchargemap.io/v3/poi/?key=YOUR_KEY&operatorid=3318&countrycode=US&maxresults=2000" > /tmp/ea_stations.json

# Run import script in Docker container
docker run --rm --network npm_network \
  -v /tmp/ea_stations.json:/tmp/ea_stations.json \
  -v /tmp/import_stations.js:/app/import.js \
  node:22-alpine sh -c "npm install pg && node import.js"
```

---

## Local Development

### Prerequisites
- Node.js 22+
- Docker & Docker Compose

### Setup

```bash
# Clone repo
git clone https://github.com/mbuckingham74/ev_mapping_app.git
cd ev_mapping_app

# Install dependencies
npm install

# Create .env from example
cp .env.example .env
# Edit .env with your credentials

# Start all services (uses Docker for Postgres)
docker compose up postgres -d

# Run dev servers
npm run dev
```

- Frontend: http://localhost:5173
- Backend: http://localhost:3001
- Postgres: localhost:5432

### Available Scripts

```bash
npm run dev           # Start both client & server dev servers
npm run dev:client    # Start only frontend
npm run dev:server    # Start only backend
npm run build         # Build both for production
npm run docker:build  # Build Docker images
npm run docker:up     # Start all containers
npm run docker:down   # Stop all containers
npm run docker:logs   # View container logs
```

---

## Deployment

### Server Details
- **Host:** tachyonfuture.com
- **User:** michael
- **Auth:** SSH key
- **App location:** ~/ev_mapping_app

### Deploy Process

```bash
# SSH to server
ssh michael@tachyonfuture.com

# Navigate to app
cd ~/ev_mapping_app

# Pull latest code
git pull

# Rebuild and restart containers
docker compose build && docker compose up -d

# Check logs
docker compose logs -f
```

### Nginx Proxy Manager

- **URL:** https://npm.tachyonfuture.com
- **Proxy Host:** ev.tachyonfuture.com → ea-planner-frontend:80
- **SSL:** Let's Encrypt (auto-renew)
- **Settings:** SSL forced, HTTP/2, HSTS enabled

---

## Troubleshooting

### Check container status
```bash
docker ps | grep ea-planner
```

### View logs
```bash
docker compose logs -f backend
docker compose logs -f frontend
docker compose logs -f postgres
```

### Database access
```bash
docker exec -it ea-planner-postgres psql -U ea_planner -d ea_planner

# Useful queries
SELECT COUNT(*) FROM stations;
SELECT state, COUNT(*) FROM stations GROUP BY state ORDER BY count DESC;
```

### Restart services
```bash
docker compose restart backend
docker compose restart frontend
```

### Full rebuild
```bash
docker compose down
docker compose build --no-cache
docker compose up -d
```

---

## API Keys & Credentials

Stored in `.env` (gitignored):

| Key | Purpose |
|-----|---------|
| DB_PASSWORD | Postgres password |
| NREL_API_KEY | NREL AFDC API (currently unused) |
| OPENCHARMAP_API_KEY | OpenChargeMap API |
| OPENROUTESERVICE_API_KEY | Routing API (for future use) |

---

## Future Enhancements

From the original planning document (`.EV_PLANNING.md`):

- [ ] Route planning between origin/destination
- [ ] On-road mode with GPS and battery percentage
- [ ] Pre-computed driving distances between stations
- [ ] Elevation-adjusted range calculations
- [ ] Station ranking by charger speed, count, and facility type
- [ ] PWA offline support
- [ ] User preferences (vehicle range, efficiency)
