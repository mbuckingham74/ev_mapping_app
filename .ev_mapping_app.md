# EV - Technical Documentation

## Overview

EV is a web application for planning driving routes and finding Electrify America (EA) DC fast-charging stations along the route. It displays EA stations on an interactive map and provides station details including charger count, power output, and location information.

Key features built so far:
- **Route planning**: start/end can be city or full address; optional waypoints.
- **Stations along route**: PostGIS corridor query (miles) with per-station mile marker and inter-station distances.
- **Elevation metrics**: route total gain/loss plus per-leg gain/loss between stations (displayed as ± feet).
- **DC charger optimized routing**: may choose a longer route to include more charging options; includes a long-route fallback that inserts up to 2 EA "auto waypoints".
- **Viability-first corridor expansion**: in charger-optimized mode, can automatically widen the corridor (up to 80 mi) to reduce max gaps to within your range (with a warning message).
- **Caching**: DB-backed caching for ORS geocoding/directions and full route responses to reduce latency and rate-limit failures.
- **Station ranking**: stations returned along a route include a rank (A–D tier) based on power, stall count, off-route distance, and status.
- **Station status indicators**: green/red dots in the UI show operational (E) vs temporarily unavailable stations; status is refreshed daily from OpenChargeMap.
- **Map UX**: highlights max-gap segment, marks optimizer waypoints, and clicking a station in the list pans/opens that marker.
- **Color-coded route segments**: route displayed in green for gaps ≤80 miles, red overlay for gaps >80 miles between chargers; tooltips show gap distance when zoomed in.
- **Truck stops along route**: loads truck stop POIs from a CSV and projects them onto the route corridor (orange markers); filterable by brand via checkboxes. Default filter shows only major chains (Love's, Pilot/Flying J, TA+Petro, Road Ranger).
- **Color-coded endpoints**: start marker is green; destination marker is red (to distinguish from chargers and truck stops).
- **"Must stop" stations**: flags critical chargers (gap > 120 mi and no station within 50 mi after) with a MUST STOP list badge, highlighted marker, and a map-only filter toggle.
- **Navigation export**: export to Google Maps with charging stations + truck stops as waypoints (sorted by mile marker); Apple Maps export for start/end (waypoints not supported by Apple Maps web).
- **Print route summary**: generates a printable HTML page with route stats, all charging stations, distances, power ratings, and status indicators.
- **Accounts + preferences**: users can sign in and save routes plus vehicle/routing preferences (range, corridor, detour factor, etc.).
- **Risk alerts**: warns when max station gap exceeds your range or would arrive below your min arrival %.
- **Share + save**: shareable URL parameters; saved routes are per-user.
- **Daily data refresh**: cron job runs `npm run fetch:stations:prod` at 4 AM daily to keep station status current.

**Live URL:** https://ev.tachyonfuture.com
**GitHub:** https://github.com/mbuckingham74/ev_mapping_app

---

## Architecture

```
┌─────────────────────────────────────────────────────────────────┐
│                        Nginx Proxy Manager                       │
│                    (ev.tachyonfuture.com:443)                   │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                         npm_network                              │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐ │
│  │    Frontend     │  │    Backend      │  │  Postgres/PostGIS │ │
│  │  (nginx:alpine) │  │  (node:alpine)  │  │   (postgis:16)    │ │
│  │     :80         │──│     :3001       │──│     :5432       │ │
│  │                 │  │                 │  │                 │ │
│  │ ea-planner-     │  │ ea-planner-     │  │ ea-planner-     │ │
│  │ frontend        │  │ backend         │  │ postgres        │ │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
```

### Request Flow

1. User visits https://ev.tachyonfuture.com
2. Nginx Proxy Manager terminates SSL and forwards to `ea-planner-frontend:80`
3. Frontend (nginx) serves static React app
4. React app makes API calls to `/api/*`
5. Frontend nginx proxies `/api/*` requests to `ea-planner-backend:3001`
6. Backend queries Postgres database and returns JSON

---

## Technology Stack

### Frontend (`/client`)
- **React 19** - UI framework
- **TypeScript** - Type safety
- **Vite** - Build tool and dev server
- **Tailwind CSS v4** - Styling
- **React-Leaflet** - Map component (OpenStreetMap tiles)
- **nginx:alpine** - Production web server

### Backend (`/server`)
- **Node.js 22** - Runtime
- **Express.js 5** - Web framework
- **TypeScript** - Type safety
- **pg (node-postgres)** - PostgreSQL client
- **CORS** - Cross-origin resource sharing

### Database
- **PostgreSQL 16 + PostGIS** (Alpine)
- Schema migrations + `stations`, `saved_routes`, and auth tables (`users`, `user_sessions`, `user_preferences`)

### Infrastructure
- **Docker** & **Docker Compose** - Containerization
- **Nginx Proxy Manager** - Reverse proxy & SSL
- **Let's Encrypt** - SSL certificates

---

## Project Structure

```
ev-app/
├── client/                    # React frontend
│   ├── src/
│   │   ├── App.tsx           # Main app with map
│   │   ├── index.css         # Tailwind imports
│   │   ├── main.tsx          # React entry point
│   │   ├── components/
│   │   │   └── RoutePlanner.tsx  # Route planner + station list + save/share
│   │   ├── services/
│   │   │   └── api.ts        # API client functions
│   │   └── types/
│   │       ├── route.ts      # Route API types
│   │       ├── savedRoute.ts # Saved route API types
│   │       └── station.ts    # Station types
│   ├── Dockerfile            # Multi-stage build → nginx
│   ├── nginx.conf            # Nginx config with /api proxy
│   ├── package.json
│   ├── vite.config.ts        # Vite + Tailwind config
│   └── tsconfig.json
│
├── server/                    # Express backend
│   ├── src/
│   │   ├── config.ts         # Centralized env/config
│   │   ├── index.ts          # Express server entry
│   │   ├── db.ts             # Postgres connection & schema
│   │   ├── migrations.ts     # SQL migration runner
│   │   └── routes/
│   │       ├── route.ts      # /api/route (geocode + directions + stations + truck stops along route)
│   │       ├── savedRoutes.ts # /api/saved-routes (save/load/share routes)
│   │       └── stations.ts   # /api/stations routes
│   ├── scripts/
│   │   └── fetch-stations.ts # Data import script (OpenChargeMap)
│   ├── migrations/           # SQL migrations (run on startup)
│   ├── Dockerfile            # Multi-stage build
│   ├── package.json
│   └── tsconfig.json
│
├── docker-compose.yml         # All 3 services
├── package.json               # Monorepo root (workspaces)
├── truck_stop_location_data/  # Truck stop POI CSV data
├── .env                       # Environment variables (gitignored)
├── .env.example               # Template for .env
├── .gitignore
├── .EV_PLANNING.md           # Original planning document
└── .ev_mapping_app.md        # This file
```

---

## Database Schema

Schema is managed via SQL migrations in `server/migrations/` and applied automatically on backend startup.

### `stations` Table

```sql
CREATE TABLE stations (
  id INTEGER PRIMARY KEY,           -- Station ID (from data source)
  station_name TEXT NOT NULL,       -- Display name
  street_address TEXT,              -- Street address
  city TEXT,                        -- City
  state TEXT,                       -- State abbreviation (e.g., "FL")
  zip TEXT,                         -- ZIP code
  latitude DOUBLE PRECISION NOT NULL,
  longitude DOUBLE PRECISION NOT NULL,
  ev_dc_fast_num INTEGER DEFAULT 0, -- Number of DC fast chargers
  ev_connector_types TEXT[],        -- Array of connector types
  facility_type TEXT,               -- e.g., "WALMART", "TARGET", "OTHER"
  status_code TEXT,                 -- "E" = available, "T" = temp unavailable
  ev_pricing TEXT,                  -- Pricing info (text)
  access_days_time TEXT,            -- Hours of operation
  max_power_kw INTEGER              -- Maximum charger power in kW
);

CREATE INDEX idx_stations_state ON stations(state);
CREATE INDEX idx_stations_coords ON stations(latitude, longitude);
-- PostGIS index (used for stations-along-route corridor queries)
-- CREATE INDEX stations_location_geog_gist_idx ON stations USING GIST ((ST_SetSRID(ST_MakePoint(longitude, latitude), 4326)::geography));
```

### `saved_routes` Table

Saved route parameters for share/load.

```sql
CREATE TABLE saved_routes (
  id BIGSERIAL PRIMARY KEY,
  user_id BIGINT REFERENCES users(id),
  name TEXT,
  start_query TEXT NOT NULL,
  end_query TEXT NOT NULL,
  waypoints TEXT[] NOT NULL DEFAULT '{}',
  corridor_miles INTEGER NOT NULL DEFAULT 15,
  preference TEXT NOT NULL DEFAULT 'fastest',
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);
```

### Auth tables

```sql
CREATE TABLE users (
  id BIGSERIAL PRIMARY KEY,
  email TEXT NOT NULL UNIQUE,
  password_hash TEXT NOT NULL,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

CREATE TABLE user_sessions (
  id BIGSERIAL PRIMARY KEY,
  user_id BIGINT NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  token_hash TEXT NOT NULL UNIQUE,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  last_seen_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  expires_at TIMESTAMPTZ NOT NULL
);

CREATE TABLE user_preferences (
  user_id BIGINT PRIMARY KEY REFERENCES users(id) ON DELETE CASCADE,
  vehicle_name TEXT,
  range_miles INTEGER NOT NULL DEFAULT 210,
  efficiency_mi_per_kwh DOUBLE PRECISION,
  battery_kwh DOUBLE PRECISION,
  min_arrival_percent INTEGER NOT NULL DEFAULT 10,
  default_corridor_miles INTEGER NOT NULL DEFAULT 30,
  default_preference TEXT NOT NULL DEFAULT 'charger_optimized',
  max_detour_factor DOUBLE PRECISION NOT NULL DEFAULT 1.25,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);
```

### `schema_migrations` Table

Tracks applied migrations.

```sql
CREATE TABLE schema_migrations (
  id TEXT PRIMARY KEY,
  applied_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);
```

---

## API Endpoints

Base URL: `https://ev.tachyonfuture.com/api`

### POST /route
Plans a route using OpenRouteService (geocode + directions), then returns EA stations within a corridor around the route polyline.

```bash
curl -X POST https://ev.tachyonfuture.com/api/route \
  -H 'Content-Type: application/json' \
  -d '{
    "start":"Gainesville, FL",
    "end":"Seattle, WA",
    "waypoints":[],
    "corridorMiles":40,
    "preference":"charger_optimized"
  }'
```

**Request body (JSON):**
- `start` (string, required) — city or full address
- `end` (string, required) — city or full address
- `waypoints` (string[], optional) — intermediate stops (max 10)
- `corridorMiles` (number, optional) — corridor width for “stations along route” (miles)
- `autoCorridor` (boolean, optional) — when `true`, starts at a narrow corridor and widens only as needed to keep max gaps within your range
- `preference` (`fastest` | `charger_optimized`, optional)
- Advanced (optional): `rangeMiles` (default 210), `minArrivalPercent` (default 10), `maxDetourFactor` (default 1.25; 1.25 = allow routes up to 25% longer than the fastest route)

If `minArrivalPercent` / `rangeMiles` / `maxDetourFactor` are omitted and the user is signed in, the backend will use the saved preferences when available.

Note: the backend may return a larger `corridor_miles` than the requested `corridorMiles` if it needs to widen the corridor to reduce max station gaps to within your range (especially in `charger_optimized` mode, or when `autoCorridor=true`).

**Response fields (high level):**
- `summary`: `distance_meters`, `duration_seconds`, plus `elevation_gain_ft` and `elevation_loss_ft`
- `geometry`: route polyline as `[lat, lng][]`
- `corridor_miles`: corridor used for station lookup (may be greater than the requested `corridorMiles`)
- `stations`: stations along route with `distance_to_route_miles`, `distance_along_route_miles`, leg distances, and per-leg elevation deltas (`elevation_from_prev_ft`, `elevation_to_next_ft`); also includes `rank_score`, `rank_tier`, and `rank`
- `truck_stops`: truck stop POIs along route with `brand`, `name`, optional `address` / `phone` / `truck_parking_spots`, plus `distance_to_route_miles` and `distance_along_route_miles`
- `max_gap_miles`: largest gap between stations along the route
- `auto_waypoints`: stations inserted by the optimizer (when applicable)
- `preference` and `requested_preference`: what was requested vs what was returned
- `candidates_evaluated`: number of candidate routes scored
- `warning`: optional notes (e.g., corridor expansion)

### GET /stations
Returns all stations, optionally filtered by state.

```bash
# All stations
curl https://ev.tachyonfuture.com/api/stations

# Filter by state
curl https://ev.tachyonfuture.com/api/stations?state=FL
```

**Response:** Array of station objects

### GET /stations/:id
Returns a single station by ID.

```bash
curl https://ev.tachyonfuture.com/api/stations/123456
```

### GET /stations/near/:lat/:lng
Returns stations near a location, sorted by distance.

```bash
# Stations within 100 miles of Orlando
curl "https://ev.tachyonfuture.com/api/stations/near/28.5384/-81.3789?radius=100&limit=20"
```

**Query params:**
- `radius` - Search radius in miles (default: 100)
- `limit` - Max results (default: 20)

### GET /stations/stats/count
Returns total station count.

```bash
curl https://ev.tachyonfuture.com/api/stations/stats/count
# {"total":1129}
```

### GET /health
Health check endpoint.

```bash
curl https://ev.tachyonfuture.com/api/health
# {"status":"ok","timestamp":"2025-12-17T00:45:00.000Z"}
```

### Auth

Cookie-based auth (httpOnly session cookie).

#### GET /auth/me
Returns the current session (or `user:null` if signed out) plus preferences.

```bash
curl https://ev.tachyonfuture.com/api/auth/me
```

#### POST /auth/signup
Create an account and start a session.

```bash
curl -X POST https://ev.tachyonfuture.com/api/auth/signup \
  -H 'Content-Type: application/json' \
  -d '{"email":"you@example.com","password":"your-password"}'
```

#### POST /auth/login
Start a session.

```bash
curl -X POST https://ev.tachyonfuture.com/api/auth/login \
  -H 'Content-Type: application/json' \
  -d '{"email":"you@example.com","password":"your-password"}'
```

#### POST /auth/logout
End the current session.

```bash
curl -X POST https://ev.tachyonfuture.com/api/auth/logout
```

#### PATCH /auth/preferences
Update user preferences + vehicle attributes.

```bash
curl -X PATCH https://ev.tachyonfuture.com/api/auth/preferences \
  -H 'Content-Type: application/json' \
  -d '{"vehicleName":"Kia EV6","rangeMiles":215,"maxDetourFactor":1.25}'
```

### Saved routes

Saved routes are per-user; auth is required to list/create. Legacy routes with `user_id = NULL` are readable without auth (for old share links).

#### GET /saved-routes
Returns the most recent saved routes (currently capped at 50).

```bash
curl https://ev.tachyonfuture.com/api/saved-routes
```

#### GET /saved-routes/:id
Fetch a saved route by id.

```bash
curl https://ev.tachyonfuture.com/api/saved-routes/1
```

#### POST /saved-routes
Create a saved route.

```bash
curl -X POST https://ev.tachyonfuture.com/api/saved-routes \
  -H 'Content-Type: application/json' \
  -d '{
    "name":"Florida to Seattle",
    "start":"Gainesville, FL",
    "end":"Seattle, WA",
    "waypoints":[],
    "corridorMiles":40,
    "preference":"charger_optimized"
  }'
```

### Share links

The UI can generate shareable links. Supported query parameters:
- `start` (string), `end` (string)
- `wp` (string, repeatable for multiple waypoints)
- `corridor` (number)
- `auto` (`1` to enable auto corridor)
- `pref` (`fastest` | `charger_optimized`)
- `saved` (number, saved route id; requires auth if the route is private)

Note: if the backend widens the corridor to find a viable route, the UI will update the displayed corridor (and share URL) to match the returned `corridor_miles`.

---

## Docker Configuration

### docker-compose.yml

Three services on the `npm_network` (external network managed by Nginx Proxy Manager):

| Service | Container Name | Image | Port | Purpose |
|---------|---------------|-------|------|---------|
| frontend | ea-planner-frontend | nginx:alpine | 80 | Serves React app, proxies /api |
| backend | ea-planner-backend | node:22-alpine | 3001 | Express API server |
| postgres | ea-planner-postgres | postgis/postgis:16-3.4-alpine | 5432 | Database (Postgres + PostGIS) |

### Environment Variables

The backend reads from environment variables set in `docker-compose.yml`:

```yaml
environment:
  - NODE_ENV=production
  - PORT=3001
  - DB_HOST=postgres           # Container name
  - DB_PORT=5432
  - DB_NAME=ea_planner
  - DB_USER=ea_planner
  - DB_PASSWORD=${DB_PASSWORD}  # From .env file
  - CORS_ORIGIN=https://ev.tachyonfuture.com
  - SESSION_COOKIE_NAME=ea_session
  - SESSION_TTL_DAYS=30
  # Optional caching TTLs (defaults shown)
  - GEOCODE_CACHE_TTL_DAYS=30
  - DIRECTIONS_CACHE_TTL_DAYS=7
  - ROUTE_CACHE_TTL_SECONDS=600
  # Optional POI overlays
  - TRUCK_STOPS_CSV_PATH=/app/truck_stop_location_data/truck-rv_fuel_stations.csv
```

In `docker-compose.yml`, the backend mounts `./truck_stop_location_data` into the container (read-only) so the CSV is available at the configured path.

### Frontend Nginx Config

The frontend nginx proxies API requests to the backend:

```nginx
location /api/ {
    proxy_pass http://backend:3001/api/;
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
}
```

To prevent “blank page after deploy” issues, the production nginx config:
- Returns `404` for missing hashed assets under `/assets/` (no SPA fallback).
- Disables caching for `index.html` so browsers don’t pin old bundle hashes.

---

## Data Sources

### Primary: OpenChargeMap API
- **URL:** https://api.openchargemap.io/v3/poi/
- **Operator ID:** 3318 (Electrify America)
- **Current data:** 1,129 stations

### Alternative: NREL AFDC API (currently unreachable)
- **URL:** https://api.nrel.gov/alt-fuel-stations/v1.json
- **Note:** Connection times out from both local and server networks

### Truck stops (CSV)
- **Source:** `truck_stop_location_data/truck-rv_fuel_stations.csv`
- **Usage:** projected into the current route corridor and returned as `truck_stops` in `POST /api/route`; shown as orange markers with a brand filter in the UI
- **CSV format:** `lng,lat,"name-city,state","address|phone|truck parking"`

### Data Import Process

Since NREL API is unreliable/unreachable from some networks, station data is fetched from OpenChargeMap:

```bash
npm run fetch:stations        # Development (uses tsx)
npm run fetch:stations:prod   # Production (uses compiled JS)
```

The importer (`server/src/scripts/fetch-stations.ts`) upserts returned stations and prunes stations that are no longer returned.

### Automated Daily Refresh

A cron job refreshes station data daily at 4 AM server time:

```
0 4 * * * ~/ev_mapping_app/scripts/refresh-stations.sh >> ~/ev_mapping_app/logs/station-refresh.log 2>&1
```

The refresh script (`scripts/refresh-stations.sh`) runs the fetch command inside the Docker container:

```bash
docker compose exec -T backend npm run fetch:stations:prod
```

This keeps station status codes (`E` = operational, `T` = temporarily unavailable) current within 24 hours of OpenChargeMap data.

---

## Local Development

### Prerequisites
- Node.js 22+
- Docker & Docker Compose

### Setup

```bash
# Clone repo
git clone https://github.com/mbuckingham74/ev_mapping_app.git
cd ev_mapping_app

# Install dependencies
npm install

# Create .env from example
cp .env.example .env
# Edit .env with your credentials

# Start Postgres/PostGIS (Docker)
npm run docker:dev:up

# Run dev servers
npm run dev
```

- Frontend: http://localhost:5173
- Backend: http://localhost:3001
- Postgres: localhost:5432

Truck stop POIs are loaded from `truck_stop_location_data/truck-rv_fuel_stations.csv` when present. To override the location, set `TRUCK_STOPS_CSV_PATH`.

### Available Scripts

```bash
npm run dev           # Start both client & server dev servers
npm run dev:client    # Start only frontend
npm run dev:server    # Start only backend
npm run build         # Build both for production
npm run docker:build  # Build Docker images
npm run docker:up     # Start all containers
npm run docker:down   # Stop all containers
npm run docker:logs   # View container logs
```

---

## Deployment

### Server Details
- **Host:** tachyonfuture.com
- **User:** michael
- **Auth:** SSH key
- **App location:** ~/ev_mapping_app

### Deploy Process

```bash
# SSH to server
ssh michael@tachyonfuture.com

# Navigate to app
cd ~/ev_mapping_app

# Pull latest code
git pull

# Rebuild and restart containers
docker compose build && docker compose up -d

# Check logs
docker compose logs -f
```

### Nginx Proxy Manager

- **URL:** https://npm.tachyonfuture.com
- **Proxy Host:** ev.tachyonfuture.com → ea-planner-frontend:80
- **SSL:** Let's Encrypt (auto-renew)
- **Settings:** SSL forced, HTTP/2, HSTS enabled

---

## Troubleshooting

### Check container status
```bash
docker ps | grep ea-planner
```

### View logs
```bash
docker compose logs -f backend
docker compose logs -f frontend
docker compose logs -f postgres
```

### Database access
```bash
docker exec -it ea-planner-postgres psql -U ea_planner -d ea_planner

# Useful queries
SELECT COUNT(*) FROM stations;
SELECT state, COUNT(*) FROM stations GROUP BY state ORDER BY count DESC;
```

### Restart services
```bash
docker compose restart backend
docker compose restart frontend
```

### Full rebuild
```bash
docker compose down
docker compose build --no-cache
docker compose up -d
```

---

## Security

The backend implements several security measures:

### Database Connection
- **SSL Support**: Configurable via `DB_SSL` and `DB_SSL_MODE` environment variables
- `DB_SSL=true` enables SSL connections to PostgreSQL
- `DB_SSL_MODE=verify` (default) validates server certificates; use `no-verify` for self-signed certs
- **Connection Pooling**: Configurable pool settings (`DB_POOL_MAX`, `DB_POOL_CONNECTION_TIMEOUT_MS`, `DB_POOL_IDLE_TIMEOUT_MS`)

### HTTP Security
- **X-Content-Type-Options**: `nosniff` header prevents MIME type sniffing
- **X-Frame-Options**: `DENY` prevents clickjacking
- **X-Powered-By**: Disabled to avoid fingerprinting
- **HSTS**: Enforced at the reverse proxy layer (Nginx Proxy Manager)

### Rate Limiting
- Login endpoint: 10 requests per 15 minutes per IP
- Signup endpoint: 5 requests per 15 minutes per IP
- Uses in-memory store (resets on restart; for horizontal scaling, use Redis)
- Requires `trust proxy` for correct client IP behind reverse proxy

### Request Handling
- **JSON Body Limit**: 100kb (Express default, explicit for visibility)
- **Error Handler**: Returns JSON for all errors (including body-parser failures)

### Logging
- **Structured Logging**: pino/pino-http for JSON logs in production
- **Sensitive Data Redaction**: Authorization headers, cookies, and passwords are redacted
- **Session Cookie Protection**: Response headers (including set-cookie) are not logged
- **Request Correlation**: All logs include request ID for tracing

---

## API Keys & Credentials

Stored in `.env` (gitignored):

| Key | Purpose |
|-----|---------|
| DB_PASSWORD | Postgres password |
| NREL_API_KEY | NREL AFDC API (currently unused) |
| OPENCHARMAP_API_KEY | OpenChargeMap API |
| OPENROUTESERVICE_API_KEY | OpenRouteService geocoding + directions |

---

## Future Enhancements

From the original planning document (`.EV_PLANNING.md`):

- [x] Saved routes: add auth/users + per-user privacy
- [x] PostGIS for true "stations near polyline" queries
- [x] Route caching (ORS geocode/directions + full route response)
- [ ] On-road mode with GPS and battery percentage
- [x] Elevation gain/loss metrics (route + station legs)
- [ ] Elevation-adjusted range calculations
- [x] Station ranking by charger speed, count, and facility type
- [ ] PWA offline support
- [x] User preferences (vehicle range, efficiency, min kW/connectors)
- [x] Export to Google Maps with waypoints
- [x] Print/PDF route summary
- [x] Station status indicators (operational vs unavailable)
- [x] Color-coded route segments by gap distance
- [x] Daily automated station data refresh
- [x] Default truck stop brand filter (major chains only)
